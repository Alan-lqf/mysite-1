{% extends "mysite/base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% load mptt_tags %}
{% load avatar_tags %}


{% block title %}
    {{ blog.title }}
{% endblock %}


{% block additional_head %}
    <!-- Custom CSS -->
    <link href="{% static 'blogs/blog-post.css' %}" rel="stylesheet">
    <link href="{% static 'blogs/myblog.css' %}" rel="stylesheet">
    <!-- Custom JS-->
    <script type="text/javascript">
    $(document).ready(function(){
        $(".reply_div").hide();
        $(".update_div").hide();

        $("button[name='reply-comment']").click(function(){
            var comment_id = $(this).attr('id').split("_")[1];
            $("#reply-div_" + comment_id).toggle(500);
            if ($(this).children('i').attr('class') === 'fa fa-arrow-down')
            {
                $(this).children('i').attr('class', 'fa fa-arrow-up');
                $(this).children('span').html('Retract')
            }
            else
            {
                $(this).children('i').attr('class', 'fa fa-arrow-down');
                $(this).children('span').html('Reply')
            }
        });

        $("button[name='update-comment']").click(function(){
            var comment_id = $(this).attr('id').split("_")[1];
            $.ajax({
                url: $("#update-div_" + comment_id).attr('data-comment-url'),
                dataType: "json",
                success: function (data) {
                    $("#update-div_" + comment_id).find('textarea').val(data.text);
                }
            });
            $("#comment-div_" + comment_id).hide();
            $("#update-div_" + comment_id).show(500);
        });

        $("button[name='cancel-btn']").click(function(){
            var comment_id = $(this).attr('id').split("_")[1];
            $("#comment-div_" + comment_id).show();
            $("#update-div_" + comment_id).hide(500);
        });
    });
    </script>
    <script src="{% static 'blogs/jquery.truncate.js' %}"></script>
    <script src="{% static 'blogs/render-content.js' %}"></script>
{% endblock %}


{% block content %}
    <!-- Page Content -->
    <!-- Blog Post -->
    <br/>
    <div class="blog-detail_div well">
        <!-- Title -->
        <h1>{{ blog.title }}</h1>

        <!-- Author -->
        <p class="lead">
            by <a href="#">{{ blog.author }}</a>
        </p>

        <!-- Date/Time -->
        <p><span class="glyphicon glyphicon-time"></span> Posted on {{ blog.publish_time }}</p>
        {% if blog.last_update_time %}
        <p><span class="glyphicon glyphicon-time"></span> Last Edit on {{ blog.last_update_time }}</p>
        {% endif %}

        {% if blog.blogcategory_set.all.count is not 0 %}
            <p>
                Category:
                {% for category in blog.blogcategory_set.all %}
                    <a href="{% url 'blogs:category' category %}">{{ category }}</a>
                {% endfor %}
            </p>
        {% endif %}

        <br/>

        <!--&lt;!&ndash; Preview Image &ndash;&gt;-->
        <!--<img class="img-responsive" src="http://placehold.it/900x300" alt="">-->

        <!-- Post Content -->
        <p class="lead"><div class="blog_content">{{ blog.text }}</div></p>

        <!--edit button-->
        {% if user == blog.author or user.is_superuser %}
        <a class="btn btn-primary" href="{% url 'blogs:blog_update' blog.id %}">Edit</a>
        {% endif %}

        <hr>

        <!-- Blog Comments -->

        {% if user.is_authenticated %}
        <!-- Comments Form -->
        <div class="comment-area">
            <h4>Leave a Comment:</h4>
            <form role="form" method="POST" action="{% url 'blogs:addComment' blog.id %}">
                {% csrf_token %}
                <div class="form-group">
                    {{ comment_form|crispy }}
                </div>
                <button type="submit" class="btn btn-primary">Submit</button>
            </form>
        </div>

        <hr>
        {% endif %}
        <!-- Posted Comments -->

        <!-- Use tree node to implement comment thread-->
        {% recursetree nodes %}
        <div class="media">
            <div class="media-left">
                {% avatar node.author 64 %}
            </div>
            <div class="media-body">
                <h4 class="media-heading">{{ node.author }}
                    <small>
                        {{ node.publish_time }}
                    </small>
                    <br/>
                    {% if node.last_update_time %}
                    <small>
                        Last Edit on {{ node.last_update_time }}
                    </small>
                    {% endif %}
                </h4>
                <div class="inner-comment" id="comment-div_{{ node.id }}">
                    {{ node.text }}

                    <!--post reply-->
                    {% if user.is_authenticated %}
                    <button class="btn btn-link" name="reply-comment" id="reply-btn_{{ node.id }}">
                        <span>Reply</span> <i class="fa fa-arrow-down" aria-hidden="true"></i>
                    </button>
                    {% if node.author == user or user.is_superuser %}
                    <button class="btn btn-link" name="update-comment" id="update-btn_{{ node.id }}">
                        <span>Edit</span> <i class="fa fa-pencil-square-o" aria-hidden="true"></i>
                    </button>
                    {% endif %}
                    <div class="reply_div" id="reply-div_{{ node.id }}">
                        <form role="form" method="POST" action="{% url 'blogs:addNestedComment' node.id %}">
                            {% csrf_token %}
                            <div class="form-group">
                                {{ comment_form|crispy }}
                            </div>
                            <button type="submit" class="btn btn-primary">Submit</button>
                        </form>
                    </div>
                    {% endif %}
                </div>
                {% if user.is_authenticated and node.author == user or user.is_superuser %}
                <div class="update_div" id="update-div_{{ node.id }}" data-comment-url="{% url 'blogs:getComment' node.id %}">
                    <form role="form" method="POST" action="{% url 'blogs:updateComment' node.id %}">
                        {% csrf_token %}
                        <div class="form-group">
                            {{ comment_form|crispy }}
                        </div>
                        <button type="submit" class="btn btn-primary">Submit</button>
                        <button type="button" class="btn btn-default" name="cancel-btn" id="cancel-btn_{{ node.id }}">Cancel</button>
                    </form>
                </div>
                {% endif %}
                {% if not node.is_leaf_node %}
                    <div class="children media">
                        {{ children }}
                    </div>
                {% endif %}
            </div>
        </div>
        {% endrecursetree %}
    </div>

{% endblock %}
